{% extends "map/header.html" %}
{% block content%}

{% load leaflet_tags %}

<head>
    {% leaflet_js %}
    {% leaflet_css %}
</head>
<style>
  #yourmap {
    width: 100%;
    height: calc(100vh - 65px);
  }

  .leaflet-container.crosshair-cursor-enabled {
    cursor:crosshair;
  }

  .extra-marker.extra-marker-svg i {
    width: 36px !important;
  }

  .text-white {
    color: #fff;
  }

  .leaflet-control-layers-expanded, .leaflet-control-layers{
    background-color: #795548;
    border: 2px solid #795548 !important;
    margin-bottom: calc(50vh - 82px) !important;
    margin-left: 0 !important;
    border-radius: 0px 5px 5px 0px !important;
  }

  .leaflet-bar-part-single i {
    margin-top: 3px;
  }

  .leaflet-control-locate a {
    padding-top: 4px;
  }

</style>
<body>
    {% leaflet_map "yourmap" %}
    <div class="fixed-action-btn">
      <a class="btn-floating btn-large brown">
        <i class="large material-icons">add</i>
      </a>
      <ul>
        {% if user.is_authenticated %}
        <li><a class="btn-floating red darken-3" title="Share my Position" onclick="selectUserPosition()"><i style="font-size: 18px;" class="fa fa-user"></i></a></li>
        {% endif %}
        <li><a class="btn-floating yellow darken-3" title="New Event" onclick="selectEventPosition()"><i style="font-size: 18px;" class="fa fa-calendar-alt"></i></a></li>
        <li><a class="btn-floating green darken-3" title="New Place" onclick="selectPlacePosition()"><i class="material-icons">location_on</i></a></li>
        <!-- <li><a class="btn-floating blue darken-3" title="New Small Ad"><i class="material-icons">local_offer</i></a></li> -->
      </ul>
    </div>
</body>
<script charset="utf-8">

    // -- init map --

    var map = null;
    var new_popup = L.popup({minWidth: 300, closeOnClick: false, keepInView: false});
    var edit_popup = L.popup({offset: [1,-25], minWidth: 300, keepInView: true});
    var current_popup_event;
    var event_layer = L.layerGroup();
    var place_layer = L.layerGroup();
    var profile_layer = L.layerGroup();
    var events = JSON.parse("{{events|escapejs}}");
    var places = JSON.parse("{{places|escapejs}}");
    var profiles = JSON.parse("{{profiles|escapejs}}");
    var tags = JSON.parse("{{tags|escapejs}}");
    var users = JSON.parse("{{users|escapejs}}");
    var user_id = {{user.id}}

    var yellowMarker = L.ExtraMarkers.icon({
      icon: 'fa-calendar-alt',
      markerColor: '#f9a825',
      shape: 'square',
      prefix: 'fa',
      svg: true
    });
    var greenMarker = L.ExtraMarkers.icon({
      icon: 'fa-circle',
      markerColor: '#2E7D32',
      shape: 'circle',
      prefix: 'fa',
      svg: true
    });
    var redMarker = L.ExtraMarkers.icon({
      icon: 'fa-user',
      markerColor: '#C62828',
      shape: 'square',
      prefix: 'fa',
      svg: true
    });

    // -- place markers in layers

    window.addEventListener("map:init", function (e) {
        map = e.detail.map;
        events.forEach((event, i) => {
          var marker = L.marker([event.fields.lat, event.fields.lon],{icon: yellowMarker}).bindPopup(`{% include "map/includes/popups/event.html" %}`, {minWidth: 300}).addTo(event_layer);
          event.marker = marker;
        });
        places.forEach((place, i) => {
          var marker = L.marker([place.fields.lat, place.fields.lon],{icon: greenMarker}).bindPopup(`{% include "map/includes/popups/place.html" %}`, {minWidth: 300}).addTo(place_layer);
          place.marker = marker;
        });
        profiles.forEach((profile, i) => {
          var marker = L.marker([profile.fields.lat, profile.fields.lon],{icon: redMarker}).bindPopup(`{% include "map/includes/popups/profile.html" %}`, {minWidth: 300}).addTo(profile_layer);
          profile.marker = marker;
        });

        map.on('popupopen', function(e) {
          // -- init popup popdowns
          var el = document.querySelectorAll(".dropdown-trigger");
          M.Dropdown.init(el,{coverTrigger:false, hover: false, constrainWidth: false});
          // -- cache popup-data
          current_popup_event = e;
        });


    // -- add layers to map
        profile_layer.addTo(map);
        event_layer.addTo(map);
        place_layer.addTo(map);

        var overlayMaps = {
          "Folks": profile_layer,
          "Events": event_layer,
          "Places": place_layer,
        };

        layercontrol = L.control.layers(null, overlayMaps, {collapsed:false, position: "bottomleft"}).addTo(map);
        L.control.locate({"iconElementTag" : "i", "icon" : "fa fa-crosshairs"}).addTo(map);
        layercontrol.getContainer().childNodes[1].childNodes[2].childNodes.forEach((item, i) => {
          L.DomUtil.addClass(item.childNodes[0].childNodes[0],'reset-checkbox');
          L.DomUtil.addClass(item.childNodes[0].childNodes[1],'text-white');
        });



        //loadMapView([4,7]);


    }, false);

    function loadMapView(hashes) {
      profile_layer.clearLayers();
      event_layer.clearLayers();
      place_layer.clearLayers();
      var filterd_events = events.filter(event => {
        return (event.fields.tags.some((el) => hashes.includes(el))>0)
      })
      var filterd_places = places.filter(place => {
        return (place.fields.tags.some((el) => hashes.includes(el))>0)
      })
      var filterd_profiles = profiles.filter(profile => {
        return (profile.fields.tags.some((el) => hashes.includes(el))>0)
      })
      filterd_events.forEach((item, i) => {
        var marker = L.marker([item.fields.lat, item.fields.lon],{icon: yellowMarker}).bindPopup(`{% include "map/includes/popups/event.html" %}`, {minWidth: 300}).addTo(event_layer);
        item.marker = marker;
      });
      filterd_places.forEach((item, i) => {
        var marker = L.marker([item.fields.lat, item.fields.lon],{icon: greenMarker}).bindPopup(`{% include "map/includes/popups/place.html" %}`, {minWidth: 300}).addTo(place_layer);
        item.marker = marker;
      });
      filterd_profiles.forEach((item, i) => {
        var marker = L.marker([item.fields.lat, item.fields.lon],{icon: redMarker}).bindPopup(`{% include "map/includes/popups/profile.html" %}`, {minWidth: 300}).addTo(profile_layer);
        item.marker = marker;
      });
    }

    // -- new event --

    function selectEventPosition() {
      M.toast({html: "Select Position!", classes: 'brown rounded', displayLength:4000});
      L.DomUtil.addClass(map._container,'crosshair-cursor-enabled');
      map.on('click', newEventPopUp);
    }

    function newEventPopUp(e) {
      L.DomUtil.removeClass(map._container,'crosshair-cursor-enabled');
      map.off('click');
      let event= {}
      new_popup
        .setLatLng(e.latlng)
        .setContent(`{% include "map/includes/popups/new_event.html" %}`)
        .openOn(map);
      document.getElementById("lat").value = e.latlng.lat.toFixed(6);
      document.getElementById("lon").value = e.latlng.lng.toFixed(6);
      initDatepicker();
    }

    function editEvent() {
      current_popup_event.popup.remove();
      var event = events.filter(evt => {
        return evt.marker == current_popup_event.popup._source;
      })
      event=event[0];

      edit_popup
        .setLatLng(L.latLng(event.fields.lat,event.fields.lon))
        .setContent(`{% include "map/includes/popups/new_event.html" %}`)
        .openOn(map);
      document.getElementById("id_title").value = event.fields.title;
      document.getElementById("id_text").value = event.fields.text;
      document.getElementById("id_date_start").value = new Date(event.fields.date_start).toISOString().substring(0, 10);
      document.getElementById("id_date_end").value = new Date(event.fields.date_end).toISOString().substring(0, 10);
      tags.forEach((item, i) => {
        if(event.fields.tags.includes(item.pk)) document.getElementById(`id_tags_${i}`).setAttribute("checked", "");
      });
      document.getElementById("lat").value = event.fields.lat.toFixed(6);
      document.getElementById("lon").value = event.fields.lon.toFixed(6);
      document.getElementById("event_id").value = event.pk;


      initDatepicker();
      M.textareaAutoResize(document.getElementById("id_text"));
      M.updateTextFields();
    }

    function deleteEvent() {
      current_popup_event.popup.remove();
      var event = events.find(evt => {
        return evt.marker == current_popup_event.popup._source;
      })
      var url = "api/";
      var params = `id=${event.pk}&type=delete_event&csrfmiddlewaretoken={{ csrf_token }}`;
      var xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);

      //Send the proper header information along with the request
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.addEventListener("load", evt => {
        event.marker.remove();
        events = events.filter(item => item !== event)
        M.toast({html: "Event deleted", classes: 'green darken-3 rounded', displayLength:4000});
      });
      xhr.addEventListener("error", evt => {
        M.toast({html: "An error occurred while delting this event", classes: 'red rounded', displayLength:4000});
      });
      xhr.send(params);
      }

    // -- new place --

    function selectPlacePosition() {
      M.toast({html: "Select Position!", classes: 'brown rounded', displayLength:4000});
      L.DomUtil.addClass(map._container,'crosshair-cursor-enabled');
      map.on('click', newPlacePopUp);
    }

    function newPlacePopUp(e) {
      L.DomUtil.removeClass(map._container,'crosshair-cursor-enabled');
      map.off('click');
      position= e.latlng;
      new_popup
        .setLatLng(e.latlng)
        .setContent(`{% include "map/includes/popups/new_place.html" %}`)
        .openOn(map);
      document.getElementById("lat").value = e.latlng.lat.toFixed(6);
      document.getElementById("lon").value = e.latlng.lng.toFixed(6);
    }

    function editPlace(e) {
      current_popup_event.popup.remove();
      var place = places.filter(pla => {
        return pla.marker == current_popup_event.popup._source;
      })
      place=place[0];

      edit_popup
        .setLatLng(L.latLng(place.fields.lat, place.fields.lon))
        .setContent(`{% include "map/includes/popups/new_place.html" %}`)
        .openOn(map);
      document.getElementById("id_title").value = place.fields.title;
      document.getElementById("id_text").value = place.fields.text;
      tags.forEach((item, i) => {
        if(place.fields.tags.includes(item.pk)) document.getElementById(`id_tags_${i}`).setAttribute("checked", "");
      });
      document.getElementById("lat").value = place.fields.lat.toFixed(6);
      document.getElementById("lon").value = place.fields.lon.toFixed(6);
      document.getElementById("place_id").value = place.pk;

      M.textareaAutoResize(document.getElementById("id_text"));
      M.updateTextFields();
    }

    function deletePlace() {
      current_popup_event.popup.remove();
      var place = places.find(pla => {
        return pla.marker == current_popup_event.popup._source;
      })
      var url = "api/";
      var params = `id=${place.pk}&type=delete_place&csrfmiddlewaretoken={{ csrf_token }}`;
      var xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);

      //Send the proper header information along with the request
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.addEventListener("load", evt => {
        place.marker.remove();
        places = places.filter(item => item !== place)
        M.toast({html: "Place deleted", classes: 'green darken-3 rounded', displayLength:4000});
      });
      xhr.addEventListener("error", evt => {
        M.toast({html: "An error occurred while delting this place", classes: 'red rounded', displayLength:4000});
      });
      xhr.send(params);
    }

    // -- new user position ---

    function selectUserPosition() {
      M.toast({html: "Select Position!", classes: 'brown rounded', displayLength:2000});
      L.DomUtil.addClass(map._container,'crosshair-cursor-enabled');
      map.on('click', postUserPosition);
    }

    function postUserPosition(e) {
      L.DomUtil.removeClass(map._container,'crosshair-cursor-enabled');
      map.off('click');

      var profile = profiles.find(item => item.fields.user == user_id);
      profile.fields.lat = e.latlng.lat.toFixed(6);
      profile.fields.lon = e.latlng.lng.toFixed(6);

      var url = "api/";
      var params = `lat=${e.latlng.lat.toFixed(6)}&lng=${e.latlng.lng.toFixed(6)}&type=user_position&csrfmiddlewaretoken={{ csrf_token }}`;
      var xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);

      //Send the proper header information along with the request
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.onload = () => {
        profile.marker.remove();
        var marker = L.marker([profile.fields.lat, profile.fields.lon],{icon: redMarker}).bindPopup(`{% include "map/includes/popups/profile.html" %}`, {minWidth: 300}).addTo(profile_layer);
        profile.marker = marker;
        M.toast({html: "You added your position to the map", classes: 'green darken-3 rounded', displayLength:4000});
      }
      xhr.onerror = () => {
        M.toast({html: "An error occurred while sending your position", classes: 'red rounded', displayLength:4000});
      }
      xhr.send(params);
    }

    function getTagText(id) {
      var tag = tags.filter(item => {
              return item.pk == id;
            })
      return tag[0].fields.tag;
    }

    function getUsernameById(id) {
      var user = users.filter(item => {
              return item.pk == id;
            })
      return user[0].fields.username;
    }

    function submitForm(form) {
      const XHR = new XMLHttpRequest();
      const FD = new FormData( form );
      XHR.open( "POST", "api/" );
      XHR.onload = (r) => {
        let str = escapeString(r.target.response);
        console.log(str);
        let object = JSON.parse(str);
        object = object.object;
        console.log(object);
        if(object.model === "map.place") {
          place = object;
          place.fields.text = document.getElementById('id_text').value;
          place.fields.title = document.getElementById('id_title').value;
          current_popup_event.popup.remove();
          if (places.some(item => item.pk == place.pk)) {
            var old = places.find(pla =>  pla.pk == place.pk);
            old.marker.remove();
            places = places.filter(pla => pla.pk != place.pk)
          }
          places.push(place);
          var marker = L.marker([place.fields.lat, place.fields.lon],{icon: greenMarker}).bindPopup(`{% include "map/includes/popups/place.html" %}`, {minWidth: 300}).addTo(place_layer);
          place.marker = marker;
        }
        if(object.model === "map.event") {
          event = object;
          event.fields.text = document.getElementById('id_text').value;
          event.fields.title = document.getElementById('id_title').value;
          current_popup_event.popup.remove();
          if (events.some(item => item.pk == event.pk)) {
            var old = events.find(pla =>  pla.pk == event.pk);
            old.marker.remove();
            events = events.filter(pla => pla.pk != event.pk)
          }
          events.push(event);
          var marker = L.marker([event.fields.lat, event.fields.lon],{icon: yellowMarker}).bindPopup(`{% include "map/includes/popups/event.html" %}`, {minWidth: 300}).addTo(event_layer);
          event.marker = marker;
        }

        M.toast({html: "Saved", classes: 'green darken-3 rounded', displayLength:4000});
      }
      XHR.onerror = () => {
        M.toast({html: "An error occurred", classes: 'red rounded', displayLength:4000});
      }
      XHR.send(FD);

      return false;
    }

    function escapeString(str) {
      return str
      .replaceAll(String.fromCharCode(92), ``)
      .replaceAll(String.fromCharCode(34)+"[", ``)
      .replaceAll("]"+String.fromCharCode(34), ``);
    }

    // ----- init materialize buttons ----- \\

    document.addEventListener('DOMContentLoaded', function() {
      var elems = document.querySelectorAll('.fixed-action-btn');
      var instances = M.FloatingActionButton.init(elems);
    });

    function initDatepicker() {
      var elems = document.querySelectorAll(".datepicker");
      var instances = M.Datepicker.init(elems, {container: "body", autoClose: true, format: 'yyyy-mm-dd'});
    }

</script>
{% endblock %}
